<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noa Capital | Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = { darkMode: 'class', theme: { extend: { colors: { dark: '#0f172a', card: '#1e293b', accent: '#3b82f6', success: '#22c55e', danger: '#ef4444' }, fontFamily: { sans: ['Inter', 'sans-serif'] } } } }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; } .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.5s; } @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } } .blink { animation: pulse 1s infinite; } @keyframes pulse { 50% { opacity: 0.5; } } </style>
</head>
<body class="antialiased min-h-screen flex flex-col">

    <div id="debug-bar" class="bg-blue-900 text-blue-200 text-xs text-center py-1 font-mono">
        Initialisation du système...
    </div>

    <nav class="border-b border-gray-800 bg-card/90 backdrop-blur-md sticky top-0 z-50 h-16">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="switchTab('home')">
                <div class="bg-blue-600 w-8 h-8 rounded flex items-center justify-center font-bold">N</div>
                <span class="text-xl font-bold">Noa Capital</span>
            </div>
            <div class="flex gap-2">
                <div id="status-badge" class="flex items-center gap-2 bg-gray-900 px-3 py-1 rounded border border-gray-700">
                    <span class="w-2 h-2 rounded-full bg-yellow-500 blink"></span>
                    <span class="text-[10px] font-bold text-gray-400">CONNEXION...</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-1 w-full p-4 max-w-7xl mx-auto">
        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
            <button onclick="switchTab('home')" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold">Recherche</button>
            <button onclick="switchTab('dashboard')" class="bg-gray-800 text-gray-300 px-4 py-2 rounded text-sm font-bold hover:text-white">Portefeuille</button>
        </div>

        <div id="home" class="tab-content active flex flex-col items-center justify-center min-h-[50vh]">
            <h1 class="text-4xl font-black mb-8 text-center">Market Access.</h1>
            <div class="flex w-full max-w-lg bg-gray-900 border border-gray-700 rounded-lg p-2">
                <input type="text" id="tickerInput" class="bg-transparent w-full text-white px-4 focus:outline-none" placeholder="Symbole (ex: MC.PA, AAPL)...">
                <button onclick="searchTicker()" class="bg-blue-600 px-6 py-2 rounded font-bold hover:bg-blue-500">GO</button>
            </div>
            
            <div id="resultBox" class="hidden mt-8 w-full max-w-lg bg-card border border-gray-700 rounded-xl p-6">
                <div class="flex justify-between">
                    <div>
                        <h2 id="r-name" class="text-xl font-bold">Nom</h2>
                        <span id="r-symbol" class="text-xs text-gray-500">TICKER</span>
                    </div>
                    <div class="text-right">
                        <div id="r-price" class="text-3xl font-black">--</div>
                        <div id="r-perf" class="text-sm font-bold">--</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-card rounded-xl border border-gray-700 overflow-hidden">
                    <table class="w-full text-sm text-gray-400">
                        <thead class="bg-gray-900 text-xs uppercase">
                            <tr><th class="px-4 py-3 text-left">Titre</th><th class="px-4 py-3 text-right">Prix</th><th class="px-4 py-3 text-right">Valo</th><th class="px-4 py-3 text-right">Perf</th></tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-800"></tbody>
                    </table>
                </div>
                <div class="bg-card rounded-xl border border-gray-700 p-6">
                    <div class="text-sm text-gray-400 uppercase">Valeur Totale</div>
                    <div id="totalVal" class="text-4xl font-extrabold text-white mt-1">-- €</div>
                    <div id="totalPv" class="text-sm font-bold mt-2">--</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- !!! COLLE TA CLÉ ICI !!! ---
        const API_KEY = "d548en9r01qlj84bhjfgd548en9r01qlj84bhjg0"; 

        // Données Backup (si clé invalide ou erreur)
        let portfolio = [
            { tick: "AI.PA",  name: "Air Liquide", q: 20, pru: 171.18, price: 0 },
            { tick: "SU.PA",  name: "Schneider",   q: 10, pru: 236.99, price: 0 },
            { tick: "TTE.PA", name: "Total",       q: 38, pru: 56.97,  price: 0 },
            { tick: "AIR.PA", name: "Airbus",      q: 5,  pru: 212.46, price: 0 },
            { tick: "SGO.PA", name: "St-Gobain",   q: 7,  pru: 88.15,  price: 0 },
            { tick: "BRES.PA",name: "ETF Res.",    q: 6,  pru: 104.84, price: 0 }
        ];

        // LOGGING
        function log(msg, error=false) {
            const bar = document.getElementById('debug-bar');
            bar.innerText = msg;
            bar.className = error ? "bg-red-900 text-red-200 text-xs text-center py-1 font-mono" : "bg-blue-900 text-blue-200 text-xs text-center py-1 font-mono";
            console.log(msg);
        }

        // MOTEUR "FORCEUR" (Proxy + Finnhub)
        async function fetchPrice(symbol) {
            if(API_KEY.includes("METS_TA_CLE")) {
                log("ERREUR : CLÉ MANQUANTE LIGNE 98 !", true);
                return null;
            }

            // On passe par corsproxy pour contourner le blocage Chrome
            const targetUrl = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEY}`;
            const proxyUrl = "https://corsproxy.io/?" + encodeURIComponent(targetUrl);

            try {
                log(`Appel Finnhub pour ${symbol}...`);
                const res = await fetch(proxyUrl);
                
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                
                const data = await res.json();
                if(data.c === 0 && data.d === null) throw new Error("Ticker Inconnu / Marché Fermé");
                
                return data.c; // Retourne le prix courant
            } catch (e) {
                log(`Echec ${symbol}: ${e.message}`, true);
                return null;
            }
        }

        async function updateData() {
            let successCount = 0;
            const statusBadge = document.getElementById('status-badge');

            for (let stock of portfolio) {
                // Petit délai pour éviter l'erreur 429 (Trop d'appels)
                await new Promise(r => setTimeout(r, 250)); 
                
                const price = await fetchPrice(stock.tick);
                if (price) {
                    stock.price = price;
                    successCount++;
                } else {
                    // Fallback si échec (pour pas afficher 0)
                    if(stock.price === 0) stock.price = stock.pru;
                }
                render(); // Mise à jour progressive
            }

            if(successCount > 0) {
                log("Données mises à jour avec succès via Finnhub.");
                statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span><span class="text-[10px] font-bold text-green-500 uppercase">LIVE</span>';
            } else {
                log("Échec total connexion. Vérifie ta clé ou ta connexion.", true);
                statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500"></span><span class="text-[10px] font-bold text-red-500 uppercase">DÉMO</span>';
            }
        }

        // RECHERCHE
        async function searchTicker() {
            const tick = document.getElementById('tickerInput').value.toUpperCase();
            if(!tick) return;
            
            document.getElementById('r-name').innerText = "Chargement...";
            document.getElementById('resultBox').classList.remove('hidden');
            
            const price = await fetchPrice(tick);
            if(price) {
                document.getElementById('r-name').innerText = tick;
                document.getElementById('r-symbol').innerText = "PRIX EN DIRECT";
                document.getElementById('r-price').innerText = price.toFixed(2) + " €"; // On suppose EUR
                document.getElementById('r-perf').innerText = "Donnée récupérée";
            } else {
                document.getElementById('r-name').innerText = "Introuvable";
                document.getElementById('r-price').innerText = "--";
            }
        }

        // AFFICHAGE
        function render() {
            let total = 0, invest = 0;
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            portfolio.forEach(s => {
                const valo = s.price * s.q;
                const perf = ((s.price - s.pru) / s.pru) * 100;
                total += valo;
                invest += s.pru * s.q;
                
                const color = perf >= 0 ? 'text-green-400' : 'text-red-400';
                tbody.innerHTML += `
                    <tr>
                        <td class="px-4 py-3 font-bold">${s.tick}</td>
                        <td class="px-4 py-3 text-right font-mono">${s.price.toFixed(2)}</td>
                        <td class="px-4 py-3 text-right font-bold text-white">${Math.round(valo)}</td>
                        <td class="px-4 py-3 text-right ${color} font-bold">${perf.toFixed(2)}%</td>
                    </tr>
                `;
            });

            const globalPerf = ((total - invest) / invest) * 100;
            document.getElementById('totalVal').innerText = Math.round(total).toLocaleString() + " €";
            const pvEl = document.getElementById('totalPv');
            pvEl.innerText = (globalPerf > 0 ? '+' : '') + globalPerf.toFixed(2) + " %";
            pvEl.className = globalPerf >= 0 ? "text-sm font-bold mt-2 text-green-400" : "text-sm font-bold mt-2 text-red-400";
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // Start
        render();
        updateData();
    </script>
</body>
</html>
