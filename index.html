<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noa Capital | V50 Stable</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        dark: '#0f172a', 
                        card: '#1e293b', 
                        accent: '#3b82f6', 
                        success: '#22c55e', 
                        danger: '#ef4444', 
                        gold: '#fbbf24'
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; overflow-x: hidden; }
        .tab-content { display: none; width: 100%; animation: fadeIn 0.4s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #home.active { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: calc(100vh - 64px); }
        .search-glow:focus-within { box-shadow: 0 0 40px rgba(59, 130, 246, 0.25); border-color: #3b82f6; }
        .loader { border: 3px solid #333; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display:none; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Login */
        #login-screen { position: fixed; inset: 0; z-index: 9999; background: #0f172a; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-box { width: 100%; max-width: 400px; padding: 2rem; background: #1e293b; border: 1px solid #334155; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); text-align: center; }
    </style>
</head>

<body class="antialiased min-h-screen flex flex-col">

    <div id="login-screen">
        <div class="mb-8 flex flex-col items-center gap-4">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center font-black text-3xl text-white shadow-2xl shadow-blue-900/50">N</div>
            <h1 class="text-3xl font-bold tracking-tight text-white">Noa Capital</h1>
            <p class="text-gray-400 text-sm">V50 Pro ‚Ä¢ Connected FMP</p>
        </div>
        
        <div class="login-box">
            <div class="mb-6 text-left">
                <label class="block text-xs font-bold text-blue-400 uppercase mb-2">Mot de passe</label>
                <input type="password" id="passwordInput" class="w-full bg-gray-900/50 border border-gray-700 text-white rounded-lg p-3 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="admin" onkeypress="if(event.key === 'Enter') checkLogin()">
                <p id="loginError" class="text-red-500 text-xs mt-2 hidden">Mot de passe incorrect.</p>
            </div>
            <button onclick="checkLogin()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-blue-900/20">
                Initialiser le Flux
            </button>
        </div>
    </div>

    <div id="app-container" style="display: none;" class="flex-1 flex flex-col w-full h-full">

        <nav class="border-b border-gray-800 bg-card/90 backdrop-blur-md sticky top-0 z-50 h-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-full flex items-center justify-between">
                <div class="flex items-center gap-3 cursor-pointer" onclick="switchTab('home')">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 w-9 h-9 rounded-lg flex items-center justify-center font-black text-white shadow-lg">N</div>
                    <span class="text-xl font-bold tracking-tight hidden md:block">Noa Capital</span>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex space-x-1 bg-gray-900/50 p-1 rounded-lg border border-gray-700 overflow-x-auto max-w-[250px] md:max-w-none scrollbar-hide">
                        <button onclick="switchTab('home')" id="btn-home" class="px-3 py-1.5 text-sm font-medium rounded-md bg-blue-600 text-white transition whitespace-nowrap">üîé</button>
                        <button onclick="switchTab('dashboard')" id="btn-dashboard" class="px-3 py-1.5 text-sm font-medium rounded-md text-gray-400 hover:text-white transition whitespace-nowrap">Portefeuille</button>
                        <button onclick="switchTab('macro')" id="btn-macro" class="px-3 py-1.5 text-sm font-medium rounded-md text-gray-400 hover:text-white transition whitespace-nowrap">Macro</button>
                        <button onclick="switchTab('rentes')" id="btn-rentes" class="px-3 py-1.5 text-sm font-medium rounded-md text-gray-400 hover:text-white transition whitespace-nowrap">Rentes</button>
                        <button onclick="switchTab('journal')" id="btn-journal" class="px-3 py-1.5 text-sm font-medium rounded-md text-gray-400 hover:text-white transition whitespace-nowrap">Journal</button>
                        <button onclick="switchTab('convictions')" id="btn-convictions" class="px-3 py-1.5 text-sm font-medium rounded-md text-gray-400 hover:text-white transition whitespace-nowrap">Th√®se</button>
                        <button onclick="switchTab('watchlist')" id="btn-watchlist" class="px-3 py-1.5 text-sm font-medium rounded-md text-gray-400 hover:text-white transition whitespace-nowrap">Watch</button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-1 w-full">

            <div id="home" class="tab-content active">
                <div class="text-center mb-8 w-full px-4 pt-8">
                    <h1 class="text-5xl font-black text-white mb-4">Market Intelligence.</h1>
                    <p class="text-gray-400">Flux Professionnel (FMP Data).</p>
                </div>
                <div class="w-full max-w-3xl px-4 relative z-10 mb-8">
                    <div class="search-glow bg-[#161b22] border border-gray-600 rounded-2xl p-2 flex items-center transition-all duration-300">
                        <input type="text" id="mainTickerInput" class="w-full bg-transparent border-none text-white text-xl px-4 py-4 focus:outline-none placeholder-gray-600 font-medium" placeholder="Rechercher (ex: AI.PA, AAPL)..." onkeypress="if(event.key === 'Enter') searchTicker()">
                        <button onclick="searchTicker()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-xl transition shadow-lg">GO</button>
                    </div>
                </div>
                <div id="searchLoader" class="loader mt-10"></div>
                <div id="resultCard" class="hidden w-full max-w-5xl px-4 pb-20">
                    <div class="bg-card/90 backdrop-blur border border-gray-700 rounded-2xl shadow-2xl overflow-hidden">
                        <div class="p-6 border-b border-gray-700/50 flex justify-between items-center bg-gray-800/20">
                            <div>
                                <div class="flex items-center gap-3">
                                    <h2 class="text-3xl font-bold text-white" id="res-name">Nom</h2>
                                    <span class="text-xs px-2 py-1 rounded bg-blue-900/30 text-blue-400 border border-blue-800" id="res-type">EQUITY</span>
                                </div>
                                <div class="text-gray-400 text-sm mt-1 font-mono"><span id="res-symbol">TICKER</span></div>
                            </div>
                            <div class="text-right">
                                <div class="text-5xl font-black text-white" id="res-price">--</div>
                                <div class="text-xl font-bold flex items-center justify-end gap-2" id="res-perf">-- %</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-px bg-gray-700/50">
                            <div class="bg-card p-4"><div class="text-[10px] text-gray-500 uppercase font-bold">Ouverture</div><div class="text-lg font-mono text-white" id="res-open">--</div></div>
                            <div class="bg-card p-4"><div class="text-[10px] text-gray-500 uppercase font-bold">Haut/Bas</div><div class="text-sm font-mono text-white" id="res-range">--</div></div>
                            <div class="bg-card p-4"><div class="text-[10px] text-gray-500 uppercase font-bold">Volume</div><div class="text-lg font-mono text-blue-300" id="res-vol">--</div></div>
                            <div class="bg-card p-4"><div class="text-[10px] text-gray-500 uppercase font-bold">Cap. Boursi√®re</div><div class="text-lg font-mono text-white" id="res-cap">--</div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="dashboard" class="tab-content max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                <div class="mb-8 flex justify-between items-end">
                    <div>
                        <h1 class="text-3xl font-bold text-white">Portefeuille Global</h1>
                        <p class="text-gray-400 mt-1 text-sm font-mono flex items-center gap-2">
                            <button onclick="fetchAllData()" class="bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded text-xs border border-gray-600 transition">‚Üª Actualiser</button>
                            <span id="last-update">En attente...</span>
                        </p>
                    </div>
                    <div class="text-right"><div class="text-sm text-gray-400 uppercase">AUM Total</div><div class="text-4xl font-extrabold text-white tabular-nums" id="totalVal">-- ‚Ç¨</div></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-card rounded-xl p-5 border border-gray-700 shadow-lg"><p class="text-xs font-bold text-gray-400 uppercase">Plus-Value</p><p class="mt-1 text-2xl font-bold tabular-nums" id="totalPv">--</p></div>
                    <div class="bg-card rounded-xl p-5 border border-gray-700 shadow-lg"><p class="text-xs font-bold text-gray-400 uppercase">Dividendes (An)</p><p class="mt-1 text-2xl font-bold text-indigo-400 tabular-nums" id="totalDiv">--</p></div>
                    <div class="bg-card rounded-xl p-5 border border-gray-700 shadow-lg"><p class="text-xs font-bold text-gray-400 uppercase">PER Moyen</p><p class="mt-1 text-2xl font-bold text-white tabular-nums" id="avgPER">--</p></div>
                    <div class="bg-card rounded-xl p-5 border border-gray-700 shadow-lg"><p class="text-xs font-bold text-gray-400 uppercase">Top Perf</p><p class="mt-1 text-lg font-bold text-white truncate" id="topStock">--</p><p class="text-xs font-bold text-green-400 mt-1" id="topStockPerf">--</p></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-card rounded-xl border border-gray-700 shadow-lg flex flex-col">
                        <div class="px-6 py-4 border-b border-gray-700 bg-gray-800/30"><h3 class="text-sm font-bold text-white uppercase">Positions</h3></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm text-gray-400">
                                <thead class="bg-gray-900/50 uppercase text-xs text-gray-500"><tr><th class="px-5 py-3">Soci√©t√©</th><th class="px-5 py-3 text-right">Cours</th><th class="px-5 py-3 text-center">Var. J</th><th class="px-5 py-3 text-right hidden sm:table-cell">Valo</th><th class="px-5 py-3 text-right">Perf</th></tr></thead>
                                <tbody class="divide-y divide-gray-700/50" id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-card rounded-xl border border-gray-700 shadow-lg p-6 flex flex-col">
                        <h3 class="text-sm font-bold text-white uppercase mb-4">Allocation</h3>
                        <div class="flex-1 relative min-h-[250px]"><canvas id="sectorChart"></canvas></div>
                    </div>
                </div>
            </div>

            <div id="macro" class="tab-content max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                <div class="mb-8"><h1 class="text-3xl font-bold text-white">Cockpit Macro</h1><p class="text-gray-400 mt-2">Donn√©es temps r√©el (Forex/Commodities).</p></div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-card border border-gray-700 rounded-xl p-6 relative overflow-hidden group hover:border-gold transition">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">üßà</div>
                        <h3 class="text-sm font-bold text-gold uppercase mb-2">Or (Spot USD)</h3>
                        <div class="text-3xl font-black text-white" id="macro-gold-price">--</div>
                        <div class="text-sm mt-1" id="macro-gold-var">--</div>
                    </div>
                    <div class="bg-card border border-gray-700 rounded-xl p-6 relative overflow-hidden group hover:border-gray-500 transition">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">üõ¢Ô∏è</div>
                        <h3 class="text-sm font-bold text-gray-400 uppercase mb-2">P√©trole (Brent)</h3>
                        <div class="text-3xl font-black text-white" id="macro-oil-price">--</div>
                        <div class="text-sm mt-1" id="macro-oil-var">--</div>
                    </div>
                    <div class="bg-card border border-gray-700 rounded-xl p-6 relative overflow-hidden group hover:border-blue-500 transition">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">üí∂</div>
                        <h3 class="text-sm font-bold text-blue-400 uppercase mb-2">EUR / USD</h3>
                        <div class="text-3xl font-black text-white" id="macro-eur-price">--</div>
                        <div class="text-sm mt-1" id="macro-eur-var">--</div>
                    </div>
                    <div class="bg-card border border-gray-700 rounded-xl p-6 relative overflow-hidden group hover:border-yellow-500 transition">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl">‚Çø</div>
                        <h3 class="text-sm font-bold text-yellow-500 uppercase mb-2">Bitcoin</h3>
                        <div class="text-3xl font-black text-white" id="macro-btc-price">--</div>
                        <div class="text-sm mt-1" id="macro-btc-var">--</div>
                    </div>
                </div>
            </div>

            <div id="rentes" class="tab-content max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
                <div class="mb-8"><h1 class="text-3xl font-bold text-white">Calendrier des Rentes</h1><p class="text-gray-400 mt-2">Projection des cash-flows.</p></div>
                <div class="bg-card border border-gray-700 rounded-xl overflow-hidden">
                    <div class="p-6 bg-gray-800/30 border-b border-gray-700 flex justify-between items-center"><h3 class="font-bold text-white">Prochains Paiements</h3><span class="text-xs bg-indigo-900/50 text-indigo-300 px-2 py-1 rounded border border-indigo-700">Estimations</span></div>
                    <div class="divide-y divide-gray-700/50" id="dividend-list"><div class="p-8 text-center text-gray-500 animate-pulse">En attente des prix...</div></div>
                </div>
            </div>

            <div id="journal" class="tab-content max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
                <div class="mb-8"><h1 class="text-3xl font-bold text-white">Journal</h1></div>
                <div class="bg-card border border-gray-700 rounded-xl p-6 mb-8">
                    <textarea id="journal-input" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-4 text-white placeholder-gray-500 focus:border-blue-500 outline-none h-32" placeholder="Note du jour..."></textarea>
                    <div class="flex justify-between items-center mt-4"><span class="text-xs text-gray-500">Sauvegard√© localement.</span><button onclick="saveNote()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition">Enregistrer</button></div>
                </div>
                <div class="space-y-4" id="journal-entries"></div>
            </div>

            <div id="convictions" class="tab-content max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
                <div class="mb-12 border-b border-gray-700 pb-8"><h1 class="text-4xl md:text-5xl font-black text-white tracking-tight mb-6">Th√®se d'Investissement</h1><p class="text-xl text-gray-400 leading-relaxed max-w-3xl">La Strat√©gie du R√©el vs Le Virtuel.</p></div>
                <div class="mb-16"><h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3"><span class="text-red-500">01.</span> La Grande Rotation</h2><div class="prose prose-invert prose-lg max-w-none text-gray-300 space-y-6 text-justify"><p>Nous sortons des actifs immat√©riels survaloris√©s (Tech) pour nous positionner sur des actifs tangibles sous-valoris√©s (Mines, Energie).</p></div></div>
                <div class="mb-16"><h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3"><span class="text-gold">02.</span> Raret√© Physique</h2><p class="text-gray-300">On ne peut pas imprimer du cuivre. Air Liquide, TotalEnergies et les Mines poss√®dent ce qui est vital.</p></div>
            </div>

            <div id="watchlist" class="tab-content max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
                <div class="mb-8"><h1 class="text-3xl font-bold text-white">Liste de Surveillance</h1></div>
                <div class="bg-card rounded-xl border border-gray-700 shadow-lg overflow-hidden">
                    <table class="w-full text-left text-sm text-gray-400"><thead class="bg-gray-900/50 uppercase text-xs text-gray-500"><tr><th class="px-5 py-3">Actif</th><th class="px-5 py-3">Th√®se</th><th class="px-5 py-3 text-right">Cours</th><th class="px-5 py-3 text-center">Var. J</th></tr></thead><tbody class="divide-y divide-gray-700/50" id="watchlistBody"></tbody></table>
                </div>
            </div>

        </main>
    </div>

    <script>
        const PASSWORD_CONFIG = "admin";
        
        // --- TA CL√â EST INS√âR√âE ICI ---
        const API_KEY = "wtZ4ar0LfzPrZ7XFZeoXcKTJkARx5mbK"; 
        
        // --- DONN√âES ---
        let portfolio = [
            { tick: "AI.PA",  name: "Air Liquide",        sec: "Chimie",     q: 20, pru: 171.18, div: 0.019, eps: 5.90 },
            { tick: "SU.PA",  name: "Schneider Electric", sec: "Industrie",  q: 10, pru: 236.99, div: 0.015, eps: 7.50 },
            { tick: "TTE.PA", name: "TotalEnergies",      sec: "Energie",    q: 38, pru: 56.97,  div: 0.052, eps: 8.00 },
            { tick: "AIR.PA", name: "Airbus",             sec: "A√©ro.",      q: 5,  pru: 212.46, div: 0.012, eps: 4.90 },
            { tick: "SGO.PA", name: "Saint-Gobain",       sec: "Construct.", q: 7,  pru: 88.15,  div: 0.026, eps: 5.50 },
            { tick: "BRES.PA",name: "ETF Basic Res.",     sec: "Mat√©riaux",  q: 6,  pru: 104.84, div: 0.0,   eps: 0    },
        ];

        // Initialisation √† z√©ro pour l'affichage avant chargement
        portfolio.forEach(p => { p.price = 0; p.prev = 0; });

        let watchlist = [
            { tick: "CJ1.PA", name: "Amundi Japan", thesis: "Yen", price: 0, prev: 0 },
            { tick: "AEEM.PA", name: "Amundi Emerging", thesis: "Cycle", price: 0, prev: 0 }
        ];

        let macro = [
            { tick: "GCUSD", name: "gold", price: 0, prev: 0 }, // Or Spot FMP code
            { tick: "BZUSD",  name: "oil", price: 0, prev: 0 },  // Brent
            { tick: "EURUSD", name: "eur", price: 0, prev: 0 },  
            { tick: "BTCUSD", name: "btc", price: 0, prev: 0 }   
        ];

        // --- NAVIGATION ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Gestion des boutons actifs
            ['home','dashboard','watchlist','convictions','macro','rentes','journal'].forEach(b=>{
                const el = document.getElementById('btn-'+b);
                if(el){ 
                    if(b===id){
                        el.classList.add('bg-blue-600','text-white');
                        el.classList.remove('text-gray-400','bg-transparent');
                    } else {
                        el.classList.remove('bg-blue-600','text-white');
                        el.classList.add('text-gray-400','bg-transparent');
                    } 
                }
            });

            if(id !== 'home') document.getElementById('resultCard').classList.add('hidden');
            if(id === 'rentes') renderCalendar();
            if(id === 'journal') renderJournal();
        }

        // --- MOTEUR API (FMP) ---
        async function fetchAllData() {
            // Concatenation de tous les tickers
            const allTickers = [...portfolio.map(i=>i.tick), ...watchlist.map(i=>i.tick), ...macro.map(i=>i.tick)].join(',');
            
            const updateLabel = document.getElementById('last-update');
            updateLabel.innerText = "Connexion...";
            updateLabel.className = "text-yellow-400 font-mono text-sm";
            
            const url = `https://financialmodelingprep.com/api/v3/quote/${allTickers}?apikey=${API_KEY}`;
            
            try {
                const r = await fetch(url);
                const data = await r.json();

                // Gestion d'erreur sp√©cifique FMP (Quota ou Cl√©)
                if(data['Error Message']) {
                    console.error("Erreur API FMP:", data['Error Message']);
                    updateLabel.innerText = "ERREUR CL√â/QUOTA";
                    updateLabel.className = "text-red-500 font-bold text-sm";
                    alert("Erreur API : " + data['Error Message']);
                    return;
                }

                // Mapping des donn√©es re√ßues
                data.forEach(q => {
                    let pItem = portfolio.find(i => i.tick === q.symbol);
                    if(pItem) { pItem.price = q.price; pItem.prev = q.previousClose; }
                    
                    let wItem = watchlist.find(i => i.tick === q.symbol);
                    if(wItem) { wItem.price = q.price; wItem.prev = q.previousClose; }
                    
                    let mItem = macro.find(i => i.tick === q.symbol);
                    if(mItem) { mItem.price = q.price; mItem.prev = q.previousClose; }
                });

                updateLabel.innerText = "OK " + new Date().toLocaleTimeString();
                updateLabel.className = "text-green-400 font-mono text-sm";
                
                renderDashboard();
                renderWatchlist();
                renderMacro();
                renderCalendar(); 

            } catch(e) {
                console.error(e);
                updateLabel.innerText = "Erreur R√©seau";
                updateLabel.className = "text-red-400 font-mono text-sm";
            }
        }

        // --- RENDERING ---
        function renderDashboard() {
            let totalVal = 0, totalInvest = 0, totalDiv = 0, totalPER = 0, countPER = 0;
            let topStock = { name: '-', perf: -999 };
            const tbody = document.getElementById('tableBody'); 
            tbody.innerHTML = '';

            portfolio.forEach((stock) => {
                const valo = stock.price * stock.q;
                const invest = stock.pru * stock.q;
                let perfPct = stock.pru > 0 && stock.price > 0 ? ((stock.price - stock.pru) / stock.pru) * 100 : 0;
                let dayVarPct = stock.price > 0 && stock.prev > 0 ? ((stock.price - stock.prev) / stock.prev) * 100 : 0;
                let calculatedPER = (stock.price > 0 && stock.eps > 0) ? stock.price / stock.eps : 0;

                totalVal += valo; 
                totalInvest += invest; 
                totalDiv += valo * stock.div;
                if(calculatedPER > 0) { totalPER += calculatedPER; countPER++; }
                if(perfPct > topStock.perf) topStock = { name: stock.name, perf: perfPct };
                
                const dPrice = stock.price > 0 ? stock.price.toFixed(2) + " ‚Ç¨" : '...';
                const dValo = stock.price > 0 ? Math.round(valo).toLocaleString() + " ‚Ç¨" : '-';
                
                const row = `
                <tr class="hover:bg-gray-800/50 border-b border-gray-700/50 last:border-0">
                    <td class="px-5 py-4"><div class="font-bold text-white">${stock.name}</div><div class="text-[10px] text-gray-500">${stock.tick}</div></td>
                    <td class="px-5 py-4 text-right text-white font-mono">${dPrice}</td>
                    <td class="px-5 py-4 text-center font-mono font-bold ${dayVarPct>=0?'text-green-400':'text-red-400'}">${dayVarPct>0?'+':''}${dayVarPct.toFixed(2)}%</td>
                    <td class="px-5 py-4 text-right font-bold text-gray-300 hidden sm:table-cell">${dValo}</td>
                    <td class="px-5 py-4 text-right ${perfPct>=0?'text-success':'text-danger'} font-mono font-bold">${perfPct>0?'+':''}${perfPct.toFixed(2)}%</td>
                </tr>`;
                tbody.innerHTML += row;
            });

            if(totalVal > 0) {
                const gpv = totalVal - totalInvest;
                document.getElementById('totalVal').innerText = Math.round(totalVal).toLocaleString() + " ‚Ç¨";
                document.getElementById('totalPv').innerText = (gpv > 0 ? '+' : '') + Math.round(gpv).toLocaleString() + " ‚Ç¨";
                document.getElementById('totalPv').className = `mt-1 text-2xl font-bold tabular-nums ${gpv >= 0 ? 'text-success' : 'text-danger'}`;
                document.getElementById('totalDiv').innerText = Math.round(totalDiv) + " ‚Ç¨";
                document.getElementById('avgPER').innerText = countPER > 0 ? (totalPER/countPER).toFixed(1) : "-";
                document.getElementById('topStock').innerText = topStock.name;
                document.getElementById('topStockPerf').innerText = (topStock.perf>0?'+':'') + topStock.perf.toFixed(2) + " %";
            }
            
            // Graphique Camembert
            if(window.myChart) window.myChart.destroy();
            
            // Regroupement par secteur pour le graph
            let sectors = {};
            portfolio.forEach(s => {
                if(!sectors[s.sec]) sectors[s.sec] = 0;
                sectors[s.sec] += (s.price * s.q);
            });
            
            const labels = Object.keys(sectors);
            const data = Object.values(sectors);

            window.myChart = new Chart(document.getElementById('sectorChart').getContext('2d'), { 
                type: 'doughnut', 
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        data: data, 
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#ec4899'], 
                        borderWidth: 0 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '70%', 
                    plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', boxWidth: 8, usePointStyle: true } } } 
                } 
            });
        }

        function renderMacro() {
            macro.forEach(m => {
                if(m.price > 0) {
                    const varPct = ((m.price - m.prev) / m.prev) * 100;
                    const elPrice = document.getElementById(`macro-${m.name}-price`);
                    const elVar = document.getElementById(`macro-${m.name}-var`);
                    if(elPrice) elPrice.innerText = m.price.toFixed(2);
                    if(elVar) { 
                        elVar.innerText = (varPct > 0 ? '+' : '') + varPct.toFixed(2) + "%"; 
                        elVar.className = `text-sm mt-1 font-mono font-bold ${varPct >= 0 ? 'text-green-400' : 'text-red-400'}`; 
                    }
                }
            });
        }
        
        function renderWatchlist() {
            const tbody = document.getElementById('watchlistBody'); tbody.innerHTML = '';
            watchlist.forEach(item => {
                let dayVarPct = item.price > 0 && item.prev > 0 ? ((item.price - item.prev) / item.prev) * 100 : 0;
                const dPrice = item.price > 0 ? item.price.toFixed(2) : '...';
                const row = `<tr class="hover:bg-gray-800/50 border-b border-gray-700/50 last:border-0"><td class="px-5 py-4"><div class="font-bold text-white">${item.name}</div><div class="text-[10px] text-gray-500">${item.tick}</div></td><td class="px-5 py-4 text-xs text-blue-300">${item.thesis}</td><td class="px-5 py-4 text-right text-white font-mono">${dPrice}</td><td class="px-5 py-4 text-center font-mono font-bold ${dayVarPct>=0?'text-green-400':'text-red-400'}">${dayVarPct>0?'+':''}${dayVarPct.toFixed(2)}%</td></tr>`;
                tbody.innerHTML += row;
            });
        }

        function renderCalendar() {
            const container = document.getElementById('dividend-list'); 
            container.innerHTML = ""; 
            const payments = [];
            
            portfolio.forEach(stock => {
                if(stock.price > 0) {
                    const annual = stock.q * stock.price * stock.div; 
                    if(annual < 1) return;
                    
                    // Simulation dates paiements (simplifi√©e)
                    if (stock.tick.includes("TTE")) { [0, 3, 5, 8].forEach(m => payments.push({ month: m, name: stock.name, amt: annual / 4 })); } 
                    else if (stock.tick.includes("AI") || stock.tick.includes("SU")) { payments.push({ month: 4, name: stock.name, amt: annual }); } 
                    else { payments.push({ month: 5, name: stock.name, amt: annual }); }
                }
            });
            
            if(payments.length === 0) { container.innerHTML = '<div class="p-8 text-center text-gray-500">Donn√©es en attente des prix...</div>'; return; }
            
            payments.sort((a, b) => a.month - b.month);
            const months = ["Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin", "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"];
            
            payments.forEach(p => {
                container.innerHTML += `<div class="p-4 flex justify-between items-center hover:bg-gray-800/20 transition"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-gray-800 flex items-center justify-center text-xs font-bold text-gray-500 uppercase border border-gray-700">${months[p.month].substring(0,3)}</div><div><div class="font-bold text-white">${p.name}</div></div></div><div class="text-right"><div class="text-xl font-bold text-indigo-400">+${p.amt.toFixed(2)} ‚Ç¨</div></div></div>`;
            });
        }

        // ONE SHOT SEARCH (FMP)
        async function searchTicker() {
            const t = document.getElementById('mainTickerInput').value.toUpperCase(); if(!t)return;
            document.getElementById('resultCard').classList.add('hidden'); document.getElementById('searchLoader').style.display = 'block';
            
            const url = `https://financialmodelingprep.com/api/v3/quote/${t}?apikey=${API_KEY}`;
            
            try {
                const r = await fetch(url); 
                const d = await r.json();
                
                if(d['Error Message']) { alert(d['Error Message']); throw new Error(d['Error Message']); }

                if(d.length > 0) {
                    const m = d[0];
                    document.getElementById('res-name').innerText = m.name; 
                    document.getElementById('res-symbol').innerText = m.symbol; 
                    document.getElementById('res-price').innerText = m.price.toFixed(2);
                    
                    const p = m.changesPercentage;
                    document.getElementById('res-perf').innerText = (p>0?'+':'') + p.toFixed(2) + " %";
                    document.getElementById('res-perf').className = p>=0?"text-xl font-bold flex items-center justify-end gap-2 text-green-400":"text-xl font-bold flex items-center justify-end gap-2 text-red-400";
                    
                    document.getElementById('res-open').innerText = m.open.toFixed(2); 
                    document.getElementById('res-range').innerText = m.dayLow + " - " + m.dayHigh;
                    
                    let vol = m.volume || 0; 
                    document.getElementById('res-vol').innerText = vol > 1000000 ? (vol/1000000).toFixed(1) + "M" : (vol/1000).toFixed(1) + "K";
                    
                    document.getElementById('res-cap').innerText = m.marketCap > 1000000000 ? (m.marketCap/1000000000).toFixed(2)+"B" : (m.marketCap/1000000).toFixed(2)+"M";
                    
                    document.getElementById('searchLoader').style.display='none'; 
                    document.getElementById('resultCard').classList.remove('hidden');
                } else { throw new Error("Symbol not found"); }
            } catch(e) { 
                alert("Ticker introuvable ou erreur cl√©"); 
                document.getElementById('searchLoader').style.display='none'; 
            }
        }

        function saveNote() {
            const txt = document.getElementById('journal-input').value; if(!txt)return;
            const entry = { date: new Date().toLocaleDateString(), text: txt };
            let notes = JSON.parse(localStorage.getItem('nc-journal') || "[]");
            notes.unshift(entry); localStorage.setItem('nc-journal', JSON.stringify(notes));
            document.getElementById('journal-input').value = ""; renderJournal();
        }
        function renderJournal() {
            const c = document.getElementById('journal-entries'); const notes = JSON.parse(localStorage.getItem('nc-journal') || "[]");
            c.innerHTML = ""; notes.forEach(n => c.innerHTML += `<div class="bg-gray-800/30 border border-gray-700 rounded-lg p-4"><div class="text-xs text-blue-400 font-bold mb-2">${n.date}</div><p class="text-gray-300 whitespace-pre-wrap">${n.text}</p></div>`);
        }

        function checkLogin() {
            // Mot de passe par d√©faut : admin
            if(document.getElementById('passwordInput').value === PASSWORD_CONFIG) {
                document.getElementById('login-screen').style.display='none'; 
                document.getElementById('app-container').style.display='flex';
                
                fetchAllData(); 
                renderJournal();
                
                // Refresh toutes les 5 minutes pour respecter les 250 calls/jour
                setInterval(fetchAllData, 300000); 
            } else { 
                document.getElementById('loginError').classList.remove('hidden'); 
            }
        }
    </script>
</body>
</html>
